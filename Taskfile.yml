version: '3'

dotenv:
  - '.env'

env:
  NODE_ENV: "{{ default \"development\" .NODE_ENV }}"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Global, reusable variables
vars:
  APP_NAME:       "{{ .APP_NAME       | default `express-typescript-skeleton` }}"
  TAG:            "{{ .TAG            | default `dev`                   }}"
  IMAGE_NAME:     "{{ .APP_NAME }}:{{ .TAG }}"
  CONTAINER_NAME: "{{ .APP_NAME }}-container"
  PORT:           "{{ .PORT           | default `8080`                 }}"
  DIST_DIR:       "dist"
  GIT_COMMIT:
    sh: "git rev-parse --short HEAD"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set:   ["pipefail"]
shopt: ["globstar"]

# Use "prefixed" output mode so that parallel tasks each emit a [task-name] prefix
output: prefixed

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tasks:

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                    âœ¨ Helper & Requirements Tasks âœ¨               ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  help:
    desc: "Show all available tasks"
    cmds:
      - task --list

  requirements:
    desc: "Verify that docker and pnpm are installed"
    silent: true
    preconditions:
      - sh:  "command -v docker"
        msg:  "âŒ Docker is not installed!"
      - sh:  "command -v pnpm"
        msg:  "âŒ pnpm is not installed!"
      - sh:  "command -v node"
        msg:  "âŒ Node.js is not installed!"
    cmds:
      - echo "âœ… Required tools are available."

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                      ğŸ›  Project Setup Task ğŸ›                       ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  install:
    desc: "Install dependencies via pnpm"
    deps:
      - requirements
    cmds:
      - echo "ğŸ“¦ Installing dependencies..."
      - pnpm install

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                         ğŸš€ Development Task ğŸš€                       ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  dev:
    desc: "Run development server"
    deps:
      - install
    cmds:
      - echo "ğŸš€ Starting development server..."
      - pnpm run dev

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                   ğŸ”¨ Build & Typecheck Tasks ğŸ”¨                      ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  build:
    desc: "Compile TypeScript"
    deps:
      - install
    cmds:
      - echo "ğŸ”¨ Building project..."
      - pnpm run build

  typecheck:
    desc: "Type-check only"
    deps:
      - install
    cmds:
      - echo "ğŸ” Running type-check..."
      - pnpm run typecheck

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                     âœï¸ Lint & Format Tasks âœï¸                         ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  lint:
    desc: "Run Biome lint"
    deps:
      - install
    cmds:
      - echo "ğŸ§¹ Linting code..."
      - pnpm run lint

  lint.fix:
    desc: "Auto-fix lint issues"
    deps:
      - install
    cmds:
      - echo "ğŸ§¹ Fixing lint issues..."
      - pnpm run lint:fix

  lint.knip:
    desc: "Check for unused dependencies"
    deps:
      - install
    cmds:
      - echo "ğŸ” Checking unused dependencies..."
      - pnpm run lint:knip

  lint.knip.fix:
    desc: "Fix unused dependencies"
    deps:
      - install
    cmds:
      - echo "ğŸ”§ Removing unused dependencies..."
      - pnpm run fix:knip

  format:
    desc: "Format code"
    deps:
      - install
    cmds:
      - echo "ğŸ¨ Formatting code..."
      - pnpm run format

  format.check:
    desc: "Check code formatting"
    deps:
      - install
    cmds:
      - echo "ğŸ” Verifying format..."
      - pnpm run format --check

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                       âœ… Testing Tasks âœ…                            ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  test:
    desc: "Run unit tests"
    deps:
      - install
    cmds:
      - echo "ğŸ§ª Running tests..."
      - pnpm run test

  test.ci:
    desc: "Run tests with coverage"
    deps:
      - install
    cmds:
      - echo "ğŸ§ª Running tests in CI mode with coverage..."
      - pnpm run test:cov

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                     ğŸ³ Docker & Deployment Tasks ğŸ³                    ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  docker.build:
    desc: "Build Docker image"
    requires:
      vars:
        - IMAGE_NAME
        - PORT
    deps:
      - build
    cmds:
      - 'echo "ğŸ“¦ Building Docker image: {{ .IMAGE_NAME }} (commit={{ .GIT_COMMIT }})"'
      - |
        docker build \
          --build-arg PORT={{ .PORT }} \
          --label git-commit={{ .GIT_COMMIT }} \
          -t {{ .IMAGE_NAME }} \
          -f ./Dockerfile \
          .

  docker.run:
    desc: "Run Docker container detached (production mode)"
    requires:
      vars:
        - IMAGE_NAME
        - PORT
        - CONTAINER_NAME
    preconditions:
      - sh:  "[ -f .env ]"
        msg:  "âŒ Missing .env fileâ€”cannot run container"
    deps:
      - docker.build
    cmds:
      - 'echo "â–¶ï¸ Starting Docker container: {{ .CONTAINER_NAME }} on port {{ .PORT }}"'
      - |
        docker run -d \
          --name {{ .CONTAINER_NAME }} \
          -p {{ .PORT }}:{{ .PORT }} \
          --env NODE_ENV=production \
          --env-file .env \
          {{ .IMAGE_NAME }}

  docker.logs:
    desc: "Follow logs from the running Docker container"
    requires:
      vars:
        - CONTAINER_NAME
    cmds:
      - echo "ğŸ“œ Tailing logs for {{ .CONTAINER_NAME }}..."
      - docker logs -f {{ .CONTAINER_NAME }}

  docker.stop:
    desc: "Stop and remove the Docker container"
    requires:
      vars:
        - CONTAINER_NAME
    cmds:
      - 'echo "ğŸ›‘ Stopping container: {{ .CONTAINER_NAME }}..."'
      - docker stop {{ .CONTAINER_NAME }} || true
      - docker rm {{ .CONTAINER_NAME }} || true

  docker.clean:
    desc: "Remove Docker container, image, and prune dangling images"
    requires:
      vars:
        - IMAGE_NAME
        - CONTAINER_NAME
    cmds:
      - echo "ğŸ§¼ Cleaning Docker resources for {{ .IMAGE_NAME }}..."
      - docker stop {{ .CONTAINER_NAME }} || true
      - docker rm {{ .CONTAINER_NAME }} || true
      - docker rmi {{ .IMAGE_NAME }} || true
      - docker image prune -f

  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##
  ##                       ğŸ§¹ Cleanup & Utility Tasks ğŸ§¹                   ##
  ##â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€##

  clean.dist:
    desc: "Remove compiled output directory ({{ .DIST_DIR }})"
    cmds:
      - echo "ğŸ§¹ Deleting {{ .DIST_DIR }}..."
      - rm -rf {{ .DIST_DIR }}

  clean.node:
    desc: "Remove node_modules folder and pnpm-lock.yaml"
    cmds:
      - echo "ğŸ§¹ Removing node_modules and pnpm-lock.yaml..."
      - rm -rf node_modules pnpm-lock.yaml

  clean.all:
    desc: "Full cleanup: dist/, node_modules, Docker images/containers"
    deps:
      - clean.dist
      - clean.node
      - docker.clean
    cmds:
      - echo "âœ… Completed full cleanup."

  audit:
    desc: "Run npm audit for vulnerability checks"
    deps:
      - install
    cmds:
      - echo "ğŸ”’ Auditing dependencies..."
      - npm audit --audit-level=moderate

  lefthook.install:
    desc: "Install Git hooks using Lefthook"
    deps:
      - install
    cmds:
      - echo "ğŸ”— Installing Git hooks..."
      - npx lefthook install
